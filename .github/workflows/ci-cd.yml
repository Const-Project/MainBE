# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Spring Boot CI/CD with AWS

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´ ì •ì˜
on:
  push:
    branches: [ develop ]
  pull_request:
    branches: [ develop ]

# PR ìƒì„±, ì½”ë“œ ìˆ˜ì •, AWS OIDC í† í° ìš”ì²­ì„ ìœ„í•œ ê¶Œí•œ ì„¤ì •
permissions:
  id-token: write
  contents: write
  pull-requests: write
  checks: write

jobs:
  # ì½”ë“œ í¬ë§·íŒ…, ë¹Œë“œ, í…ŒìŠ¤íŠ¸ë¥¼ ì²˜ë¦¬í•˜ëŠ” Job
  build:
    runs-on: ubuntu-latest
    outputs:
      build-success: ${{ steps.build-status.outputs.success }}
      
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì¹˜
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      # 3. Gradle ìºì‹œ ì„¤ì •
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 5. ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ ë˜ëŠ” ì ìš©
      - name: Check code formatting (PR)
        if: github.event_name == 'pull_request'
        run: ./gradlew spotlessCheck

      - name: Apply code formatting (Push)
        if: github.event_name == 'push'
        run: ./gradlew spotlessApply

      # 6. í¬ë§·íŒ… ë³€ê²½ì‚¬í•­ìœ¼ë¡œ PR ìƒì„± (ì „ëžµ 2)
      - name: Create Pull Request with formatting changes
        if: github.event_name == 'push'
        id: create_pr # stepì˜ idë¥¼ ì§€ì •í•˜ì—¬ outputì„ ì°¸ì¡°í•  ìˆ˜ ìžˆë„ë¡ í•¨
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ðŸŽ¨ [BOT] Apply Spotless code style"
          title: "ðŸŽ¨ [BOT] Apply Spotless code style"
          body: |
            Spotless ë´‡ì´ ì½”ë“œ ìŠ¤íƒ€ì¼ì„ ìžë™ìœ¼ë¡œ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.
            ë³€ê²½ ì‚¬í•­ì„ í™•ì¸í•˜ê³  ë³‘í•©í•´ ì£¼ì„¸ìš”.
            
            *This PR was auto-generated by a GitHub Action.*
          branch: "spotless-patches/${{ github.ref_name }}"
          delete-branch: true
          labels: bot, chore

      # 7. Gradleë¡œ ë¹Œë“œ ë° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      # ì¤‘ìš”: PRì´ ìƒì„±ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ(ì½”ë“œ í¬ë§·ì´ ì™„ë²½í•  ë•Œë§Œ) ë¹Œë“œ/í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.
      - name: Build with Gradle
        if: steps.create_pr.outputs.pull-request-number == ''
        run: ./gradlew build
        env:
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}

      # 8. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      - name: Publish Test Results
        if: (success() || failure()) && steps.create_pr.outputs.pull-request-number == ''
        uses: dorny/test-reporter@v1
        with:
          name: Gradle Tests
          path: build/test-results/test/*.xml
          reporter: java-junit

      # 9. ë¹Œë“œ ì„±ê³µ ìƒíƒœ ì„¤ì •
      - name: Set build success status
        id: build-status
        if: success() && steps.create_pr.outputs.pull-request-number == ''
        run: echo "success=true" >> $GITHUB_OUTPUT

  # ====================================================================
  # ì´í•˜ ë°°í¬ ê´€ë ¨ Jobë“¤ì€ 'build' Jobì˜ ìµœì¢… ì„±ê³µ ì—¬ë¶€ì— ë”°ë¼ ì‹¤í–‰ë©ë‹ˆë‹¤.
  # build Jobì—ì„œ PRì´ ìƒì„±ë˜ì–´ ë¹Œë“œë¥¼ ê±´ë„ˆë›°ë©´, build-successê°€ trueê°€ ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ
  # ì•„ëž˜ Jobë“¤ì€ ìžë™ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
  # ====================================================================

  # EC2 ìƒíƒœ í™•ì¸ ìž‘ì—…
  check-ec2:
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && needs.build.outputs.build-success == 'true'
    outputs:
      ec2-available: ${{ steps.check-ec2-status.outputs.available }}
    steps:
      - name: Check EC2 instance status
        id: check-ec2-status
        run: |
          if timeout 10 nc -z ${{ secrets.EC2_HOST }} 22 2>/dev/null; then
            echo "EC2 instance is reachable"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "EC2 instance is not reachable or stopped"
            echo "available=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
  build-and-push-image:
    runs-on: ubuntu-latest
    needs: [build, check-ec2]
    if: github.event_name == 'push' && needs.build.outputs.build-success == 'true' && needs.check-ec2.outputs.ec2-available == 'true'
    outputs:
      image-pushed: ${{ steps.push-status.outputs.success }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: cp_main_be
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push --all-tags $ECR_REGISTRY/$ECR_REPOSITORY
      - name: Set push success status
        id: push-status
        if: success()
        run: echo "success=true" >> $GITHUB_OUTPUT

  # EC2 ë°°í¬ ìž‘ì—…
  deploy:
    runs-on: ubuntu-latest
    needs: [build, check-ec2, build-and-push-image]
    if: github.event_name == 'push' && needs.build-and-push-image.outputs.image-pushed == 'true'
    steps:
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Deploy to EC2 instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
            ECR_REPOSITORY="cp_main_be"
            # AWS CLI ì„¤ì • ë° docker login
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY
            # ì´ë¯¸ì§€ pull
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            if [ $(docker ps -a -q -f name=spring-app-container) ]; then
              docker stop spring-app-container
              docker rm spring-app-container
            fi
            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ ë° ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            source /etc/environment
            docker run -d --name spring-app-container -p 8080:8080 \
            -e DB_URL="$DB_URL" \
            -e DB_USERNAME="$DB_USERNAME" \
            -e DB_PASSWORD="$DB_PASSWORD" \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e R2_ENDPOINT="${{ secrets.R2_ENDPOINT }}" \
            -e R2_BUCKET="${{ secrets.R2_BUCKET }}" \
            -e R2_ACCESS_KEY="${{ secrets.R2_ACCESS_KEY }}" \
            -e R2_SECRET_KEY="${{ secrets.R2_SECRET_KEY }}" \
            $ECR_REGISTRY/$ECR_REPOSITORY:latest

  # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
  summary:
    runs-on: ubuntu-latest
    needs: [build, check-ec2, build-and-push-image, deploy]
    if: always()
    steps:
      - name: Workflow Summary
        run: |
          echo "## ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "| ë‹¨ê³„ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ | ${{ needs.build.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨/ê±´ë„ˆëœ€' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "| EC2 ìƒíƒœ í™•ì¸ | ${{ needs.check-ec2.result == 'success' && 'âœ… ì„±ê³µ' || (needs.check-ec2.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨') }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Docker ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ | ${{ needs.build-and-push-image.result == 'success' && 'âœ… ì„±ê³µ' || (needs.build-and-push-image.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨') }} |" >> $GITHUB_STEP_SUMMARY
            echo "| EC2 ë°°í¬ | ${{ needs.deploy.result == 'success' && 'âœ… ì„±ê³µ' || (needs.deploy.result == 'skipped' && 'â­ï¸ ê±´ë„ˆëœ€' || 'âŒ ì‹¤íŒ¨') }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ë°°í¬ ê´€ë ¨ ìž‘ì—… | â­ï¸ ê±´ë„ˆëœ€ (PR ì´ë²¤íŠ¸) |" >> $GITHUB_STEP_SUMMARY
          fi
