# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„
name: Spring Boot CI/CD with AWS

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´ ì •ì˜
on:
  push:
    branches: [ develop ] # develop ë¸Œëžœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì‹¤í–‰

# OIDC í† í° ìš”ì²­ì„ ìœ„í•œ ê¶Œí•œ ì„¤ì • (í•„ìˆ˜)
permissions:
  id-token: write
  contents: read

jobs:
  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ìž‘ì—… (í•­ìƒ ì‹¤í–‰)
  build:
    runs-on: ubuntu-latest
    outputs:
      build-success: ${{ steps.build-status.outputs.success }}
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì¹˜ (Corretto ë°°í¬íŒ ì‚¬ìš©)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'

      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      # 4. Gradleë¡œ ë¹Œë“œ ë° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Build with Gradle
        run: ./gradlew build
        env:
          # --- DB ê´€ë ¨ ì‹œí¬ë¦¿ ì¶”ê°€ ---
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      
          # --- ê¸°ì¡´ R2 ê´€ë ¨ ì‹œí¬ë¦¿ ---
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
          R2_ACCESS_KEY: ${{ secrets.R2_ACCESS_KEY }}
          R2_SECRET_KEY: ${{ secrets.R2_SECRET_KEY }}

      # 5. ë¹Œë“œ ì„±ê³µ ìƒíƒœ ì„¤ì •
      - name: Set build success status
        id: build-status
        run: echo "success=true" >> $GITHUB_OUTPUT

  # EC2 ìƒíƒœ í™•ì¸ ìž‘ì—…
  check-ec2:
    runs-on: ubuntu-latest
    needs: build
    outputs:
      ec2-available: ${{ steps.check-ec2-status.outputs.available }}
    
    steps:
      # EC2 ì¸ìŠ¤í„´ìŠ¤ ìƒíƒœ í™•ì¸
      - name: Check EC2 instance status
        id: check-ec2-status
        run: |
          # EC2ì— ping í…ŒìŠ¤íŠ¸ (timeout 10ì´ˆ)
          if timeout 10 nc -z ${{ secrets.EC2_HOST }} 22 2>/dev/null; then
            echo "EC2 instance is reachable"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "EC2 instance is not reachable or stopped"
            echo "available=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ (EC2ê°€ ì‚¬ìš© ê°€ëŠ¥í•  ë•Œë§Œ)
  build-and-push-image:
    runs-on: ubuntu-latest
    needs: [build, check-ec2]
    if: needs.check-ec2.outputs.ec2-available == 'true'
    outputs:
      image-pushed: ${{ steps.push-status.outputs.success }}
    
    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Source Code
        uses: actions/checkout@v4

      # 2. AWS ìžê²© ì¦ëª… ì„¤ì • (OIDC ë°©ì‹)
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 3. Amazon ECRì— ë¡œê·¸ì¸
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ, íƒœê¹…, ECRì— í‘¸ì‹œ
      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: cp_main_be
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
          docker push --all-tags $ECR_REGISTRY/$ECR_REPOSITORY

      # 5. ì´ë¯¸ì§€ í‘¸ì‹œ ì„±ê³µ ìƒíƒœ ì„¤ì •
      - name: Set push success status
        id: push-status
        run: echo "success=true" >> $GITHUB_OUTPUT

  # EC2 ë°°í¬ ìž‘ì—… (ì´ë¯¸ì§€ í‘¸ì‹œê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ)
  deploy:
    runs-on: ubuntu-latest
    needs: [build, check-ec2, build-and-push-image]
    if: needs.build-and-push-image.outputs.image-pushed == 'true'
    
    steps:
      # 1. AWS ìžê²© ì¦ëª… ì„¤ì • (ECR ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ìœ„í•´)
      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      # 2. Amazon ECRì— ë¡œê·¸ì¸ (ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ìœ„í•´)
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 3. EC2ì— ì ‘ì†í•˜ì—¬ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Deploy to EC2 instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # í•˜ë“œì½”ë”©ëœ ê°’ìœ¼ë¡œ í…ŒìŠ¤íŠ¸
            ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
            ECR_REPOSITORY="cp_main_be"
            AWS_REGION="${{ secrets.AWS_REGION }}"
            
            echo "ECR_REGISTRY: $ECR_REGISTRY"
            echo "ECR_REPOSITORY: $ECR_REPOSITORY"
            echo "AWS_REGION: $AWS_REGION"
            
            # AWS CLI ì„¤ì •
            aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
            
            # 1. ì´ë¯¸ì§€ pull
            docker pull $ECR_REGISTRY/$ECR_REPOSITORY:latest
            
            # 2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            if [ $(docker ps -a -q -f name=spring-app-container) ]; then
              docker stop spring-app-container
              docker rm spring-app-container
            fi
            
            # í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
            source /etc/environment
            
            # 3. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            docker run -d --name spring-app-container -p 8080:8080 \
            -e DB_URL="$DB_URL" \
            -e DB_USERNAME="$DB_USERNAME" \
            -e DB_PASSWORD="$DB_PASSWORD" \
            -e SPRING_PROFILES_ACTIVE=prod \
            -e R2_ENDPOINT="${{ secrets.R2_ENDPOINT }}" \
            -e R2_BUCKET="${{ secrets.R2_BUCKET }}" \
            -e R2_ACCESS_KEY="${{ secrets.R2_ACCESS_KEY }}" \
            -e R2_SECRET_KEY="${{ secrets.R2_SECRET_KEY }}" \
            $ECR_REGISTRY/$ECR_REPOSITORY:latest

  # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
  summary:
    runs-on: ubuntu-latest
    needs: [build, check-ec2, build-and-push-image, deploy]
    if: always()
    
    steps:
      - name: Workflow Summary
        run: |
          echo "## ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "| ë‹¨ê³„ | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ | ${{ needs.build.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| EC2 ìƒíƒœ í™•ì¸ | ${{ needs.check-ec2.outputs.ec2-available == 'true' && 'âœ… ì‚¬ìš© ê°€ëŠ¥' || 'âš ï¸ ì‚¬ìš© ë¶ˆê°€' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.check-ec2.outputs.ec2-available }}" == "true" ]]; then
            echo "| Docker ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ | ${{ needs.build-and-push-image.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| EC2 ë°°í¬ | ${{ needs.deploy.result == 'success' && 'âœ… ì„±ê³µ' || 'âŒ ì‹¤íŒ¨' }} |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Docker ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ | â­ï¸ ê±´ë„ˆëœ€ (EC2 ì‚¬ìš© ë¶ˆê°€) |" >> $GITHUB_STEP_SUMMARY
            echo "| EC2 ë°°í¬ | â­ï¸ ê±´ë„ˆëœ€ (EC2 ì‚¬ìš© ë¶ˆê°€) |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.check-ec2.outputs.ec2-available }}" == "false" ]]; then
            echo "ðŸ’¡ **ì°¸ê³ **: EC2 ì¸ìŠ¤í„´ìŠ¤ê°€ ì¤‘ì§€ë˜ì–´ ìžˆê±°ë‚˜ ì ‘ê·¼í•  ìˆ˜ ì—†ì–´ì„œ ë°°í¬ ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
            echo "ë¹Œë“œì™€ í…ŒìŠ¤íŠ¸ëŠ” ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi
